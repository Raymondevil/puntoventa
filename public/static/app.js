// Global state
let menu = [];
let extras = [];
let cart = [];
let beverageCount = 0;
let currentCategory = 'hamburguesas';

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', async function() {\n  await loadData();\n  setupEventListeners();\n  renderMenu();\n  updateCart();\n});\n\n// Load menu and extras data\nasync function loadData() {\n  try {\n    const [menuResponse, extrasResponse] = await Promise.all([\n      fetch('/api/menu'),\n      fetch('/api/extras')\n    ]);\n    \n    menu = await menuResponse.json();\n    extras = await extrasResponse.json();\n    \n    console.log('Menu loaded:', menu.length, 'items');\n    console.log('Extras loaded:', extras.length, 'items');\n  } catch (error) {\n    console.error('Error loading data:', error);\n  }\n}\n\n// Setup event listeners\nfunction setupEventListeners() {\n  // Category buttons\n  document.querySelectorAll('.category-btn').forEach(btn => {\n    btn.addEventListener('click', function() {\n      document.querySelectorAll('.category-btn').forEach(b => {\n        b.className = b.className.replace('bg-red-500 text-white', 'bg-gray-200 text-gray-700');\n      });\n      this.className = this.className.replace('bg-gray-200 text-gray-700', 'bg-red-500 text-white');\n      \n      currentCategory = this.dataset.category;\n      renderMenu();\n    });\n  });\n  \n  // Beverage controls\n  document.getElementById('beverage-decrease').addEventListener('click', () => {\n    if (beverageCount > 0) {\n      beverageCount--;\n      updateBeverageDisplay();\n      updateCart();\n    }\n  });\n  \n  document.getElementById('beverage-increase').addEventListener('click', () => {\n    beverageCount++;\n    updateBeverageDisplay();\n    updateCart();\n  });\n  \n  // Delivery type change\n  document.querySelectorAll('input[name=\"delivery\"]').forEach(radio => {\n    radio.addEventListener('change', function() {\n      const deliveryFields = document.getElementById('delivery-fields');\n      if (this.value === 'delivery') {\n        deliveryFields.style.display = 'block';\n      } else {\n        deliveryFields.style.display = 'none';\n      }\n      updateCart();\n    });\n  });\n  \n  // Customer form validation\n  document.querySelectorAll('#customer-name, #customer-whatsapp').forEach(input => {\n    input.addEventListener('input', validateForm);\n  });\n  \n  // Place order button\n  document.getElementById('place-order').addEventListener('click', placeOrder);\n  \n  // Modal controls\n  document.getElementById('close-modal').addEventListener('click', closeModal);\n  document.getElementById('send-whatsapp').addEventListener('click', sendWhatsApp);\n}\n\n// Render menu items for current category\nfunction renderMenu() {\n  const container = document.getElementById('menu-container');\n  const categoryItems = menu.filter(item => item.category === currentCategory);\n  \n  if (categoryItems.length === 0) {\n    container.innerHTML = '<div class=\"text-center text-gray-500 py-8\"><p>No hay productos en esta categor√≠a</p></div>';\n    return;\n  }\n  \n  const html = categoryItems.map(item => `\n    <div class=\"bg-gray-50 rounded-lg p-4 border hover:shadow-md transition\">\n      <div class=\"flex justify-between items-start mb-3\">\n        <div class=\"flex-1\">\n          <h3 class=\"font-bold text-lg text-gray-800\">${item.name}</h3>\n          <p class=\"text-sm text-gray-600 mb-2\">${item.base_ingredients}</p>\n          <p class=\"font-bold text-red-600 text-lg\">$${item.base_price}</p>\n        </div>\n      </div>\n      \n      <div class=\"space-y-3\">\n        <!-- Extras Section -->\n        <div>\n          <h4 class=\"font-semibold text-sm mb-2\">üçñ Ingredientes Extra:</h4>\n          <div class=\"grid grid-cols-2 gap-2 text-sm\" id=\"extras-${item.id}\">\n            ${getExtrasForCategory('extra').map(extra => `\n              <label class=\"flex items-center space-x-1\">\n                <input type=\"checkbox\" class=\"extra-checkbox\" data-item-id=\"${item.id}\" data-extra-id=\"${extra.id}\" data-price=\"${extra.price}\">\n                <span>${extra.name} (+$${extra.price})</span>\n              </label>\n            `).join('')}\n          </div>\n        </div>\n        \n        <!-- Vegetables Section -->\n        <div>\n          <h4 class=\"font-semibold text-sm mb-2\">ü•¨ Verduras (incluidas):</h4>\n          <div class=\"grid grid-cols-2 gap-2 text-sm\" id=\"vegetables-${item.id}\">\n            ${getExtrasForCategory('vegetable').map(veggie => `\n              <label class=\"flex items-center space-x-1\">\n                <input type=\"checkbox\" class=\"vegetable-checkbox\" data-item-id=\"${item.id}\" data-extra-id=\"${veggie.id}\" checked>\n                <span>${veggie.name}</span>\n              </label>\n            `).join('')}\n          </div>\n        </div>\n        \n        <!-- Sauces Section -->\n        <div>\n          <h4 class=\"font-semibold text-sm mb-2\">ü•Ñ Aderezos (incluidos):</h4>\n          <div class=\"grid grid-cols-2 gap-2 text-sm\" id=\"sauces-${item.id}\">\n            ${getExtrasForCategory('sauce').map(sauce => `\n              <label class=\"flex items-center space-x-1\">\n                <input type=\"checkbox\" class=\"sauce-checkbox\" data-item-id=\"${item.id}\" data-extra-id=\"${sauce.id}\" checked>\n                <span>${sauce.name}</span>\n              </label>\n            `).join('')}\n          </div>\n        </div>\n        \n        <!-- Quantity and Add Button -->\n        <div class=\"flex items-center justify-between pt-3 border-t\">\n          <div class=\"flex items-center space-x-3\">\n            <span class=\"font-semibold\">Cantidad:</span>\n            <button class=\"bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-600\" onclick=\"changeQuantity(${item.id}, -1)\">-</button>\n            <span class=\"font-bold text-lg w-8 text-center\" id=\"quantity-${item.id}\">1</span>\n            <button class=\"bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-green-600\" onclick=\"changeQuantity(${item.id}, 1)\">+</button>\n          </div>\n          <button class=\"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition\" onclick=\"addToCart(${item.id})\">\n            üõí Agregar\n          </button>\n        </div>\n      </div>\n    </div>\n  `).join('');\n  \n  container.innerHTML = html;\n  \n  // Add event listeners to checkboxes for price calculation\n  container.querySelectorAll('.extra-checkbox').forEach(checkbox => {\n    checkbox.addEventListener('change', () => updateItemPrice(checkbox.dataset.itemId));\n  });\n}\n\n// Get extras by category\nfunction getExtrasForCategory(category) {\n  return extras.filter(extra => extra.category === category);\n}\n\n// Change quantity for menu item\nfunction changeQuantity(itemId, change) {\n  const quantityElement = document.getElementById(`quantity-${itemId}`);\n  let quantity = parseInt(quantityElement.textContent);\n  quantity = Math.max(1, quantity + change);\n  quantityElement.textContent = quantity;\n  updateItemPrice(itemId);\n}\n\n// Update item price display based on selected extras and quantity\nfunction updateItemPrice(itemId) {\n  const item = menu.find(m => m.id == itemId);\n  if (!item) return;\n  \n  const quantity = parseInt(document.getElementById(`quantity-${itemId}`).textContent);\n  const selectedExtras = Array.from(document.querySelectorAll(`input[data-item-id=\"${itemId}\"].extra-checkbox:checked`));\n  \n  let totalExtrasPrice = selectedExtras.reduce((sum, checkbox) => {\n    return sum + parseFloat(checkbox.dataset.price);\n  }, 0);\n  \n  const totalPrice = (item.base_price + totalExtrasPrice) * quantity;\n  // You could display this price somewhere if needed\n}\n\n// Add item to cart\nfunction addToCart(itemId) {\n  const item = menu.find(m => m.id == itemId);\n  if (!item) return;\n  \n  const quantity = parseInt(document.getElementById(`quantity-${itemId}`).textContent);\n  \n  // Get selected extras\n  const selectedExtras = Array.from(document.querySelectorAll(`input[data-item-id=\"${itemId}\"].extra-checkbox:checked`))\n    .map(checkbox => {\n      const extraId = parseInt(checkbox.dataset.extraId);\n      return extras.find(e => e.id === extraId);\n    }).filter(Boolean);\n  \n  // Get selected vegetables\n  const selectedVegetables = Array.from(document.querySelectorAll(`input[data-item-id=\"${itemId}\"].vegetable-checkbox:checked`))\n    .map(checkbox => {\n      const extraId = parseInt(checkbox.dataset.extraId);\n      return extras.find(e => e.id === extraId);\n    }).filter(Boolean);\n  \n  // Get selected sauces\n  const selectedSauces = Array.from(document.querySelectorAll(`input[data-item-id=\"${itemId}\"].sauce-checkbox:checked`))\n    .map(checkbox => {\n      const extraId = parseInt(checkbox.dataset.extraId);\n      return extras.find(e => e.id === extraId);\n    }).filter(Boolean);\n  \n  // Calculate total price for this item\n  const extrasPrice = selectedExtras.reduce((sum, extra) => sum + extra.price, 0);\n  const totalPrice = (item.base_price + extrasPrice) * quantity;\n  \n  // Add to cart\n  const cartItem = {\n    menu_item: item,\n    quantity,\n    extras: selectedExtras,\n    vegetables: selectedVegetables,\n    sauces: selectedSauces,\n    total_price: totalPrice\n  };\n  \n  cart.push(cartItem);\n  updateCart();\n  \n  // Reset form\n  document.getElementById(`quantity-${itemId}`).textContent = '1';\n  document.querySelectorAll(`input[data-item-id=\"${itemId}\"].extra-checkbox`).forEach(cb => cb.checked = false);\n  document.querySelectorAll(`input[data-item-id=\"${itemId}\"].vegetable-checkbox`).forEach(cb => cb.checked = true);\n  document.querySelectorAll(`input[data-item-id=\"${itemId}\"].sauce-checkbox`).forEach(cb => cb.checked = true);\n}\n\n// Update cart display\nfunction updateCart() {\n  const cartContainer = document.getElementById('cart-items');\n  const cartTotal = document.getElementById('cart-total');\n  \n  if (cart.length === 0 && beverageCount === 0) {\n    cartContainer.innerHTML = '<p class=\"text-gray-500 text-center py-4\">Tu carrito est√° vac√≠o</p>';\n    cartTotal.textContent = '$0';\n    document.getElementById('place-order').disabled = true;\n    return;\n  }\n  \n  let html = '';\n  let subtotal = 0;\n  \n  // Cart items\n  cart.forEach((item, index) => {\n    html += `\n      <div class=\"border-b pb-3 mb-3\">\n        <div class=\"flex justify-between items-start\">\n          <div class=\"flex-1\">\n            <h4 class=\"font-semibold\">${item.quantity}x ${item.menu_item.name}</h4>\n            <p class=\"text-sm text-gray-600\">${item.menu_item.base_ingredients}</p>\n            ${item.extras.length > 0 ? `<p class=\"text-xs text-blue-600\">+ ${item.extras.map(e => e.name).join(', ')}</p>` : ''}\n            ${item.vegetables.length > 0 ? `<p class=\"text-xs text-green-600\">ü•¨ ${item.vegetables.map(v => v.name).join(', ')}</p>` : ''}\n            ${item.sauces.length > 0 ? `<p class=\"text-xs text-orange-600\">ü•Ñ ${item.sauces.map(s => s.name).join(', ')}</p>` : ''}\n          </div>\n          <div class=\"text-right\">\n            <p class=\"font-bold\">$${item.total_price}</p>\n            <button class=\"text-red-500 text-sm hover:text-red-700\" onclick=\"removeFromCart(${index})\">\n              üóëÔ∏è Quitar\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n    subtotal += item.total_price;\n  });\n  \n  // Beverages\n  if (beverageCount > 0) {\n    const beverageTotal = beverageCount * 30;\n    html += `\n      <div class=\"border-b pb-3 mb-3\">\n        <div class=\"flex justify-between items-center\">\n          <span class=\"font-semibold\">${beverageCount}x Bebida</span>\n          <span class=\"font-bold\">$${beverageTotal}</span>\n        </div>\n      </div>\n    `;\n    subtotal += beverageTotal;\n  }\n  \n  cartContainer.innerHTML = html;\n  \n  // Calculate total with delivery\n  const deliveryType = document.querySelector('input[name=\"delivery\"]:checked').value;\n  const deliveryCost = deliveryType === 'delivery' ? 20 : 0;\n  const total = subtotal + deliveryCost;\n  \n  cartTotal.textContent = `$${total}`;\n  \n  // Enable order button if cart has items and form is valid\n  validateForm();\n}\n\n// Remove item from cart\nfunction removeFromCart(index) {\n  cart.splice(index, 1);\n  updateCart();\n}\n\n// Update beverage display\nfunction updateBeverageDisplay() {\n  document.getElementById('beverage-count').textContent = beverageCount;\n}\n\n// Validate form and enable/disable order button\nfunction validateForm() {\n  const name = document.getElementById('customer-name').value.trim();\n  const whatsapp = document.getElementById('customer-whatsapp').value.trim();\n  const deliveryType = document.querySelector('input[name=\"delivery\"]:checked').value;\n  \n  let isValid = name !== '' && whatsapp !== '' && (cart.length > 0 || beverageCount > 0);\n  \n  if (deliveryType === 'delivery') {\n    const address = document.getElementById('customer-address').value.trim();\n    isValid = isValid && address !== '';\n  }\n  \n  document.getElementById('place-order').disabled = !isValid;\n}\n\n// Place order\nasync function placeOrder() {\n  const deliveryType = document.querySelector('input[name=\"delivery\"]:checked').value;\n  const deliveryCost = deliveryType === 'delivery' ? 20 : 0;\n  \n  const customer = {\n    name: document.getElementById('customer-name').value.trim(),\n    whatsapp: document.getElementById('customer-whatsapp').value.trim(),\n    address: document.getElementById('customer-address').value.trim(),\n    between_streets: document.getElementById('customer-streets').value.trim(),\n    neighborhood: document.getElementById('customer-neighborhood').value.trim()\n  };\n  \n  const subtotal = cart.reduce((sum, item) => sum + item.total_price, 0) + (beverageCount * 30);\n  const total = subtotal + deliveryCost;\n  \n  const order = {\n    customer,\n    items: cart,\n    beverages: beverageCount,\n    delivery_type: deliveryType,\n    delivery_cost: deliveryCost,\n    total_amount: total\n  };\n  \n  try {\n    const response = await fetch('/api/orders', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(order)\n    });\n    \n    const result = await response.json();\n    \n    if (result.success) {\n      // Show confirmation modal\n      document.getElementById('whatsapp-preview').textContent = result.whatsappMessage;\n      document.getElementById('order-modal').classList.remove('hidden');\n      \n      // Store WhatsApp message for sending\n      window.currentWhatsAppMessage = result.whatsappMessage;\n      \n      // Clear cart\n      cart = [];\n      beverageCount = 0;\n      updateBeverageDisplay();\n      updateCart();\n      \n      // Clear form\n      document.getElementById('customer-name').value = '';\n      document.getElementById('customer-whatsapp').value = '';\n      document.getElementById('customer-address').value = '';\n      document.getElementById('customer-streets').value = '';\n      document.getElementById('customer-neighborhood').value = '';\n      document.querySelector('input[name=\"delivery\"][value=\"pickup\"]').checked = true;\n      document.getElementById('delivery-fields').style.display = 'none';\n      \n    } else {\n      alert('Error al crear el pedido: ' + (result.error || 'Error desconocido'));\n    }\n    \n  } catch (error) {\n    console.error('Error placing order:', error);\n    alert('Error al crear el pedido. Por favor intenta de nuevo.');\n  }\n}\n\n// Send WhatsApp message\nfunction sendWhatsApp() {\n  if (window.currentWhatsAppMessage) {\n    const whatsappNumber = '523111235595';\n    const encodedMessage = encodeURIComponent(window.currentWhatsAppMessage);\n    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;\n    \n    // Open WhatsApp in new tab\n    window.open(whatsappUrl, '_blank');\n  }\n}\n\n// Close modal\nfunction closeModal() {\n  document.getElementById('order-modal').classList.add('hidden');\n  window.currentWhatsAppMessage = null;\n}